# ==============================================================================
#           [生产加固版] 可复用的 OpenAPI 合同守卫与自动打标签工作流
# ==============================================================================
name: Reusable Contract Validation & Tagging

on:
  workflow_call:
    inputs:
      spec-path:
        description: '需要进行验证的 OpenAPI 规范文件路径'
        required: true
        type: string
      create-tag:
        description: '如果为 true, 在检查成功后自动创建并推送一个新标签'
        required: false
        type: boolean
        default: false

# 优化 1: 显式声明顶层权限为 read，遵循最小权限原则
permissions:
  contents: read

jobs:
  validate:
    name: Validate OpenAPI Contract
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Ensure contract file exists
        run: |
          if [ ! -f "${{ inputs.spec-path }}" ]; then
            echo "❌ Contract file not found at: ${{ inputs.spec-path }}"
            exit 1
          fi
          echo "✅ Found contract file: ${{ inputs.spec-path }}"

      - name: Setup Node.js (for Spectral)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install yq & jq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          sudo apt-get update -y && sudo apt-get install -y jq

      - name: Validate with Spectral (warnings allowed)
        run: |
          echo "Validating with Spectral..."
          npx -y @stoplight/spectral-cli lint "${{ inputs.spec-path }}" || echo "Spectral reported issues (treated as warnings)."

      - name: Check Q-API 3.3 Profile (hard checks)
        run: |
          set -e
          CONTRACT_FILE="${{ inputs.spec-path }}"
          
          echo "=== [硬性校验] 检查 OpenAPI 版本 ==="
          OPENAPI_VERSION=$(yq '.openapi' "$CONTRACT_FILE")
          if ! echo "$OPENAPI_VERSION" | grep -E '^3\.1\.' >/dev/null; then
            echo "❌ 错误: OpenAPI 版本必须是 3.1.x (当前: $OPENAPI_VERSION)"; exit 1;
          fi
          echo "✅ OpenAPI 3.1.x OK"

          echo "=== [硬性校验] 检查 info.x-qapi-profile ==="
          QAPI_PROFILE=$(yq '.info."x-qapi-profile"' "$CONTRACT_FILE")
          if [ "$QAPI_PROFILE" != "3.3" ]; then
            echo "❌ 错误: info.x-qapi-profile 必须是 \"3.3\" (当前: $QAPI_PROFILE)"; exit 1;
          fi
          echo "✅ x-qapi-profile=3.3 OK"

          # 优化 4: 新增更扎实的硬性校验
          echo "=== [硬性校验] 检查 X-QAPI-Version header enum 包含 3.3 ==="
          yq '.components.headers."X-QAPI-Version".schema.enum[] | select(.=="3.3")' -e "$CONTRACT_FILE" >/dev/null \
            || { echo "❌ components.headers.X-QAPI-Version.schema.enum 必须包含 \"3.3\""; exit 1; }
          echo "✅ X-QAPI-Version OK"

          echo "=== [硬性校验] 检查 oauth2 security scheme ==="
          [ "$(yq '.components.securitySchemes.oauth2.type' "$CONTRACT_FILE")" = "oauth2" ] \
            || { echo "❌ components.securitySchemes.oauth2.type 必须是 oauth2"; exit 1; }
          echo "✅ oauth2 scheme OK"

          echo "=== [硬性校验] 检查每个 path 是否都有 x-qapi-domain ==="
          MISSING=$(yq '.paths | to_entries[] | select(.value | type=="object") | .value | to_entries[] | select(.value."x-qapi-domain" == null) | .key' "$CONTRACT_FILE")
          if [ -n "$MISSING" ]; then
            echo "❌ 在以下操作中缺少 x-qapi-domain:"; echo "$MISSING"; exit 1
          fi
          echo "✅ 所有操作都包含 x-qapi-domain"

          echo "✅ 所有 Q-API 3.3 硬性检查通过"

      - name: Test SDK generation (Docker)
        run: |
          set -e
          VER=7.5.0
          echo "Generating TypeScript SDK to .sdk-test ..."
          docker pull "openapitools/openapi-generator-cli:v$VER"
          # 优化 2 & 3: 指定 runner 用户属主，并统一使用 typescript-axios
          docker run --rm --user "$(id -u)":"$(id -g)" \
            -v "${{ github.workspace }}:/local" \
            openapitools/openapi-generator-cli:v$VER \
            generate -i "/local/${{ inputs.spec-path }}" -g typescript-axios \
            -o /local/.sdk-test --skip-validate-spec
          echo "✅ SDK 生成冒烟测试 OK"

  tag-release:
    name: Create and Push Tag
    if: inputs.create-tag == true
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      # 此处权限被精准提升
      contents: write

    steps:
      - name: Checkout Code with Full History
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump Version and Push Tag
        id: tag_version
        uses: anothrNick/github-tag-action@1.67.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: patch
          WITH_V: true

      - name: Print New Tag
        run: echo "Successfully tagged release: ${{ steps.tag_version.outputs.new_tag }}"
