# ==============================================================================
#           [ç”Ÿäº§åŠ å›ºç‰ˆ] å¯å¤ç”¨çš„ OpenAPI è´¨é‡é—¨ç¦ (Q-API 3.3) ä¸è‡ªåŠ¨æ‰“æ ‡ç­¾å·¥ä½œæµ
# ==============================================================================
#
# æ–‡ä»¶è·¯å¾„: .github/workflows/reusable-quality-gate.yml
# æ‰€åœ¨ä»“åº“: ci-workflows (ç”¨äºå­˜æ”¾å¯å¤ç”¨å·¥ä½œæµçš„ä¸­å¤®ä»“åº“)
#
# ç‰¹æ€§:
# - æ˜¾å¼åŒ–çš„æƒé™ç®¡ç†ï¼Œéµå¾ªæœ€å°æƒé™åŸåˆ™
# - åŒ…å«å¤šé¡¹ä¸¥æ ¼çš„ Q-API 3.3 åˆè§„æ€§ç¡¬æ€§æ£€æŸ¥
# - ä½¿ç”¨å¤šç§ linter å’Œ validator è¿›è¡Œäº¤å‰éªŒè¯
# - å¯é€‰çš„ã€åœ¨æˆåŠŸåè‡ªåŠ¨åˆ›å»ºå¹¶æ¨é€æ–°ç‰ˆæœ¬æ ‡ç­¾çš„åŠŸèƒ½
#
# ==============================================================================

name: Reusable Quality Gate (Q-API 3.3 Profile) & Tagging

on:
  workflow_call:
    inputs:
      spec-path:
        description: 'The path to the OpenAPI specification file'
        required: true
        type: string
      create-tag:
        description: 'If true, create and push a new tag upon success'
        required: false
        type: boolean
        default: false

# ä¼˜åŒ–: æ˜¾å¼å£°æ˜é¡¶å±‚æƒé™ä¸º readï¼Œéµå¾ªæœ€å°æƒé™åŸåˆ™
permissions:
  contents: read

jobs:
  # --- ä»»åŠ¡ä¸€: Lint å’Œåˆè§„æ€§æ£€æŸ¥ ---
  lint-and-verify:
    name: Lint and Verify OpenAPI Spec
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Print repo tree and validate spec path
        shell: bash
        run: |
          set -e
          echo "SPEC_PATH=${{ inputs['spec-path'] }}"
          echo "=== repo tree (depth 3) ==="
          find . -maxdepth 3 -type f | sort
          test -f "${{ inputs['spec-path'] }}" \
            && echo "[OK] Spec found: ${{ inputs['spec-path'] }}" \
            || (echo "[FAIL] Spec not found at path"; exit 1)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install yq & jq
        shell: bash
        run: |
          set -e
          YQ_VERSION=v4.44.3
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq
          sudo apt-get update -y && sudo apt-get install -y jq

      - name: Validate OpenAPI syntax (Redocly)
        shell: bash
        run: |
          set -e
          npm i -g @redocly/cli@1.15.0
          echo "ğŸ” redocly lint ${{ inputs['spec-path'] }}"
          # å…è®¸ warningï¼Œä¸é˜»æ–­æµç¨‹
          redocly lint "${{ inputs['spec-path'] }}" || true

      - name: Lint with Spectral (2nd linter)
        shell: bash
        run: |
          set -e
          npm i -g @stoplight/spectral-cli@6.11.1
          echo "ğŸ” spectral lint ${{ inputs['spec-path'] }}"
          # å…è®¸ warningï¼Œä¸é˜»æ–­æµç¨‹
          spectral lint "${{ inputs['spec-path'] }}" || true

      - name: Q-API 3.3 compliance checks (hard checks)
        shell: bash
        run: |
          set -euo pipefail
          SPEC_FILE="${{ inputs['spec-path'] }}"
          echo "=== Q-API 3.3 Compliance Checks on $SPEC_FILE ==="

          echo "[check] OpenAPI version must be 3.1.x"
          OPENAPI_VER=$(yq '.openapi' "$SPEC_FILE")
          [[ "$OPENAPI_VER" =~ ^3\.1\. ]] || { echo "[FAIL] openapi must be 3.1.x (got $OPENAPI_VER)"; exit 1; }
          echo "[ok] openapi=$OPENAPI_VER"

          echo "[check] info.x-qapi-profile must be 3.3"
          PROFILE=$(yq '.info."x-qapi-profile"' "$SPEC_FILE")
          [[ "$PROFILE" == "3.3" ]] || { echo "[FAIL] x-qapi-profile must be 3.3 (got $PROFILE)"; exit 1; }
          echo "[ok] x-qapi-profile=3.3"

          echo "[check] components.headers.X-QAPI-Version.schema.enum contains '3.3'"
          yq '.components.headers."X-QAPI-Version".schema.enum[] | select(.=="3.3")' -e "$SPEC_FILE" >/dev/null \
            || { echo "[FAIL] X-QAPI-Version enum must include '3.3'"; exit 1; }
          echo "[ok] X-QAPI-Version enum has 3.3"

          echo "[check] components.securitySchemes.oauth2.type == 'oauth2'"
          [[ "$(yq '.components.securitySchemes.oauth2.type' "$SPEC_FILE")" == "oauth2" ]] \
            || { echo "[FAIL] oauth2 security scheme missing or wrong type"; exit 1; }
          echo "[ok] oauth2 scheme detected"

          echo "[check] every operation under paths has x-qapi-domain"
          MISS=$(yq '
            .paths | to_entries[]
            | select(.value | type == "object")
            | .value | to_entries[]
            | select(.value."x-qapi-domain" == null)
            | .key' "$SPEC_FILE")
          if [ -n "$MISS" ]; then
            echo "[FAIL] Missing x-qapi-domain on operations:"
            echo "$MISS"
            exit 1
          fi
          echo "[ok] x-qapi-domain present on all operations"

          echo "âœ… All Q-API 3.3 hard checks passed."

      - name: (Optional) Cross-check using openapi-generator validate
        shell: bash
        run: |
          set -e
          VER=7.5.0
          docker pull "openapitools/openapi-generator-cli:v${VER}"
          docker run --rm -v "${{ github.workspace }}:/local" \
            "openapitools/openapi-generator-cli:v${VER}" validate \
            -i "/local/${{ inputs['spec-path'] }}"
          echo "âœ… openapi-generator validate OK"

  # --- ä»»åŠ¡äºŒ: è‡ªåŠ¨æ‰“æ ‡ç­¾ (å¯é€‰) ---
  tag-release:
    name: Create and Push Tag
    if: inputs.create-tag == true
    needs: lint-and-verify
    runs-on: ubuntu-latest
    permissions:
      # æ­¤å¤„æƒé™è¢«ç²¾å‡†æå‡ä¸º write
      contents: write

    steps:
      - name: Checkout Code with Full History
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump Version and Push Tag
        id: tag_version
        uses: anothrNick/github-tag-action@1.67.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: patch
          WITH_V: true

      - name: Print New Tag
        run: echo "Successfully tagged release: ${{ steps.tag_version.outputs.new_tag }}"
