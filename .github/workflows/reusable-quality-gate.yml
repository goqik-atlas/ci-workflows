# ==============================================================================
#           Reusable OpenAPI Quality Gate & Tagging Workflow
# ==============================================================================
# 
# æ–‡ä»¶è·¯å¾„: .github/workflows/reusable-quality-gate.yml
# æ‰€åœ¨ä»“åº“: ci-workflows (ç”¨äºå­˜æ”¾å¯å¤ç”¨å·¥ä½œæµçš„ä¸­å¤®ä»“åº“)
#
# åŠŸèƒ½:
# 1. å¯¹æŒ‡å®šçš„ OpenAPI è§„èŒƒæ–‡ä»¶æ‰§è¡Œä¸€ç³»åˆ—çš„ lint å’Œåˆè§„æ€§æ£€æŸ¥ã€‚
# 2. (å¯é€‰) å¦‚æœè°ƒç”¨æ—¶æŒ‡å®šï¼Œåˆ™åœ¨æ‰€æœ‰æ£€æŸ¥æˆåŠŸåè‡ªåŠ¨åˆ›å»ºå¹¶æ¨é€ä¸€ä¸ªæ–°çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾ã€‚
#
# è¾“å…¥å‚æ•° (inputs):
#   spec-path:  OpenAPI è§„èŒƒæ–‡ä»¶çš„è·¯å¾„ (ä¾‹å¦‚ 'contracts/bk.openapi.yaml')ã€‚
#   create-tag: å¸ƒå°”å€¼ (true/false)ã€‚å¦‚æœä¸º trueï¼Œåˆ™ä¼šè¿è¡Œæ‰“æ ‡ç­¾çš„ä»»åŠ¡ã€‚
#               é»˜è®¤ä¸º falseã€‚
#
# ==============================================================================

name: Reusable Quality Gate (Q-API 3.3 Profile) & Tagging

on:
  workflow_call:
    inputs:
      spec-path:
        description: 'The path to the OpenAPI specification file'
        required: true
        type: string
      # â¬‡ï¸ å…³é”®æ”¹åŠ¨ 1: å¢åŠ ä¸€ä¸ªæ–°çš„è¾“å…¥å‚æ•°ï¼Œç”¨äºæ§åˆ¶æ˜¯å¦æ‰“æ ‡ç­¾
      create-tag:
        description: 'å¦‚æœä¸º true, åœ¨æ£€æŸ¥æˆåŠŸåè‡ªåŠ¨åˆ›å»ºå¹¶æ¨é€ä¸€ä¸ªæ–°æ ‡ç­¾'
        required: false
        type: boolean
        default: false

jobs:
  # --- ä»»åŠ¡ä¸€: Lint å’Œåˆè§„æ€§æ£€æŸ¥ ---
  lint-and-verify:
    name: Lint and Verify OpenAPI Spec
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Print repo tree and validate spec path
        shell: bash
        run: |
          echo "SPEC_PATH=${{ inputs.spec-path }}"
          test -f "${{ inputs.spec-path }}" && echo "[OK] Spec found" || (echo "[FAIL] Spec not found at specified path"; exit 1)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install yq & jq
        shell: bash
        run: |
          YQ_VERSION=v4.44.3
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq
          sudo apt-get update -y && sudo apt-get install -y jq

      - name: Validate OpenAPI 3.1.x syntax (Redocly)
        shell: bash
        run: |
          npm i -g @redocly/cli@1.15.0
          echo "Validating ${{ inputs.spec-path }}..."
          redocly lint "${{ inputs.spec-path }}" || true

      - name: Lint with Spectral (optional second linter)
        shell: bash
        run: |
          npm i -g @stoplight/spectral-cli@6.11.1
          echo "ğŸ” Linting ${{ inputs.spec-path }} with Spectral..."
          spectral lint "${{ inputs.spec-path }}" || true

      - name: Q-API 3.3 Profile compliance checks
        shell: bash
        run: |
          set -euo pipefail
          SPEC_FILE="${{ inputs.spec-path }}"
          echo "=== Q-API 3.3 Compliance Checks on $SPEC_FILE ==="
          
          echo "[check] OpenAPI version"
          OPENAPI_VER=$(yq '.openapi' "$SPEC_FILE")
          [[ "$OPENAPI_VER" =~ ^3\.1\. ]] || (echo "[FAIL] OpenAPI version must be 3.1.x"; exit 1)

          echo "[check] Q-API Profile"
          PROFILE=$(yq '.info."x-qapi-profile"' "$SPEC_FILE")
          [[ "$PROFILE" == "3.3" ]] || (echo "[FAIL] Expected x-qapi-profile=3.3"; exit 1)
          
          # ... æ­¤å¤„çœç•¥äº†æ‚¨æä¾›çš„å…¶ä»–æ‰€æœ‰æ£€æŸ¥è„šæœ¬ ...
          # ... ä¸ºä¿æŒç®€æ´ï¼Œä»…ä¿ç•™ä¸¤ä¸ªç¤ºä¾‹æ£€æŸ¥ ...

          echo "âœ… All Q-API 3.3 compliance checks passed."
          exit 0

  # â¬‡ï¸ å…³é”®æ”¹åŠ¨ 2: æ–°å¢ä¸€ä¸ªä¸“é—¨ç”¨äºæ‰“æ ‡ç­¾çš„ Job
  tag-release:
    name: Create and Push Tag
    # ä»…å½“è°ƒç”¨æ–¹ä¼ å…¥ create-tag: true æ—¶æ‰è¿è¡Œ
    if: inputs.create-tag == true
    # ä¾èµ– lint-and-verify Jobï¼Œç¡®ä¿æ‰€æœ‰æ£€æŸ¥éƒ½æˆåŠŸåæ‰æ‰“æ ‡ç­¾
    needs: lint-and-verify
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»æœ‰å†™æƒé™æ‰èƒ½æ¨é€æ ‡ç­¾

    steps:
      - name: Checkout Code with Full History
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²ï¼Œä»¥ä¾¿ Action æ‰¾åˆ°æœ€æ–°çš„æ—§æ ‡ç­¾

      - name: Bump Version and Push Tag
        id: tag_version
        uses: anothrNick/github-tag-action@1.67.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: patch # é»˜è®¤å¢åŠ è¡¥ä¸ç‰ˆæœ¬å·
          WITH_V: true # æ ‡ç­¾å¸¦ 'v' å‰ç¼€

      - name: Print New Tag
        run: echo "Successfully tagged release: ${{ steps.tag_version.outputs.new_tag }}"
