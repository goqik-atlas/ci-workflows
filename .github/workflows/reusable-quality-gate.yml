name: Reusable Quality Gate (Q-API 3.3 · relaxed v0.9)

on:
  workflow_call:
    inputs:
      spec-path:
        description: Path to OpenAPI spec to validate
        required: true
        type: string
      create-tag:
        description: Create a git tag when validation passes
        required: false
        type: boolean
        default: false
    secrets:
      GITHUB_TOKEN:
        required: true

permissions:
  contents: read
  pull-requests: read

jobs:
  validate:
    name: Validate OpenAPI & Q-API basics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install yq & jq
        shell: bash
        run: |
          set -e
          YQ_VERSION=v4.44.3
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq
          sudo apt-get update -y && sudo apt-get install -y jq

      - name: Redocly lint (warn only)
        shell: bash
        run: |
          npm i -g @redocly/cli@1.15.0
          redocly lint "${{ inputs.spec-path }}" || true

      - name: Spectral lint (warn only)
        shell: bash
        run: |
          npm i -g @stoplight/spectral-cli@6.11.1
          spectral lint "${{ inputs.spec-path }}" || true

      - name: Q-API 3.3 hard checks (relaxed)
        shell: bash
        run: |
          set -euo pipefail
          SPEC="${{ inputs.spec-path }}"
          echo "=== Hard checks on $SPEC ==="

          # 1) OpenAPI 3.1.x
          OPENAPI_VER=$(yq '.openapi' "$SPEC")
          [[ "$OPENAPI_VER" =~ ^3\.1\. ]] || { echo "[FAIL] openapi must be 3.1.x (got $OPENAPI_VER)"; exit 1; }
          echo "[ok] openapi=$OPENAPI_VER"

          # 2) x-qapi-profile=3.3
          PROFILE=$(yq '.info."x-qapi-profile"' "$SPEC")
          [[ "$PROFILE" == "3.3" ]] || { echo "[FAIL] info.x-qapi-profile must be 3.3 (got $PROFILE)"; exit 1; }
          echo "[ok] x-qapi-profile=3.3"

          # 3) headers.X-QAPI-Version: enum 或 example 至少包含 "3.3"
          yq '.components.headers."X-QAPI-Version".schema.enum[] | select(.=="3.3")' -e "$SPEC" >/dev/null 2>&1 \
            || { [[ "$(yq '.components.headers."X-QAPI-Version".schema.example' "$SPEC")" == "3.3" ]] \
            || { echo "[FAIL] headers.X-QAPI-Version must declare 3.3 via enum or example"; exit 1; }; }
          echo "[ok] X-QAPI-Version declares 3.3"

          # 4) 安全方案：允许 bearer(http) 或 oauth2 任一存在
          SEC_BEARER=$(yq '.components.securitySchemes.bearerAuth.type' "$SPEC" 2>/dev/null || true)
          SEC_OAUTH2=$(yq '.components.securitySchemes.oauth2.type' "$SPEC" 2>/dev/null || true)
          if [[ "$SEC_BEARER" != "http" && "$SEC_OAUTH2" != "oauth2" ]]; then
            echo "[FAIL] need bearerAuth(http) or oauth2 in components.securitySchemes"
            exit 1
          fi
          echo "[ok] securitySchemes present"

          # 5) 每个 operation 都要有 x-qapi-domain（仅对 responses 存在的子键判断）
          MISS=$(
            yq '.paths|to_entries[]|.value|to_entries[]|select(.value.responses!=null)|select(.value."x-qapi-domain"==null)|.key' "$SPEC"
          )
          if [ -n "$MISS" ]; then
            echo "[FAIL] Missing x-qapi-domain on operations:"; echo "$MISS"; exit 1
          fi
          echo "[ok] x-qapi-domain present on all operations"

          echo "✅ Hard checks passed."

      - name: openapi-generator validate
        shell: bash
        run: |
          VER=7.5.0
          docker pull "openapitools/openapi-generator-cli:v${VER}"
          docker run --rm -v "${{ github.workspace }}:/local" \
            "openapitools/openapi-generator-cli:v${VER}" validate \
            -i "/local/${{ inputs.spec-path }}"
          echo "✅ openapi-generator validate OK"

  tag:
    if: ${{ inputs.create-tag == true }}
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code with Full History
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Bump Version and Push Tag
        id: tag_version
        uses: anothrNick/github-tag-action@1.67.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: patch
          WITH_V: true
      - name: Print New Tag
        run: echo "Tagged: ${{ steps.tag_version.outputs.new_tag }}"
