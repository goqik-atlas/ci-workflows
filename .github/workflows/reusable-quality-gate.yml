# â¬†ï¸ è¿™æ˜¯å¯å¤ç”¨çš„å·¥ä½œæµï¼ŒåŒ…å«äº†æ‰€æœ‰çš„å®žé™…æ£€æŸ¥é€»è¾‘
name: Reusable Quality Gate (Q-API 3.3 Profile)

# â¬‡ï¸ å…³é”®æ”¹åŠ¨ 1: è§¦å‘å™¨æ”¹ä¸º workflow_call
on:
  workflow_call:
    # â¬‡ï¸ å…³é”®æ”¹åŠ¨ 2: å°†å†™æ­»çš„ SPEC_PATH å˜æˆä¸€ä¸ªè¾“å…¥å‚æ•°
    inputs:
      spec-path:
        description: 'The path to the OpenAPI specification file'
        required: true
        type: string

jobs:
  lint-and-verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print repo tree and validate spec path
        shell: bash
        run: |
          echo "=== Repository structure ==="
          find . -maxdepth 3 -type d | sort
          echo "-----------------------------"
          # â¬‡ï¸ å…³é”®æ”¹åŠ¨ 3: ä½¿ç”¨ inputs.spec-path æ›¿ä»£ä¹‹å‰çš„ env å˜é‡
          echo "SPEC_PATH=${{ inputs.spec-path }}"
          test -f "${{ inputs.spec-path }}" && echo "[OK] Spec found" || (echo "[FAIL] Spec not found at specified path"; exit 1)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install yq & jq
        shell: bash
        run: |
          YQ_VERSION=v4.44.3
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq
          sudo apt-get update -y && sudo apt-get install -y jq
          yq --version && jq --version

      - name: Validate OpenAPI 3.1.x syntax (Redocly)
        shell: bash
        run: |
          npm i -g @redocly/cli@1.15.0
          redocly --version
          # â¬‡ï¸ å…³é”®æ”¹åŠ¨ 3: ä½¿ç”¨ inputs.spec-path
          echo "Validating ${{ inputs.spec-path }}..."
          redocly lint "${{ inputs.spec-path }}" || true

      - name: Lint with Spectral (optional second linter)
        shell: bash
        run: |
          npm i -g @stoplight/spectral-cli@6.11.1
          spectral --version
          # â¬‡ï¸ å…³é”®æ”¹åŠ¨ 3: ä½¿ç”¨ inputs.spec-path
          echo "ðŸ” Linting ${{ inputs.spec-path }} with Spectral..."
          spectral lint "${{ inputs.spec-path }}" || true

      - name: Q-API 3.3 Profile compliance checks
        shell: bash
        # â¬‡ï¸ å…³é”®æ”¹åŠ¨ 3: åœ¨æ•´ä¸ªè„šæœ¬ä¸­éƒ½ä½¿ç”¨ inputs.spec-path
        run: |
          set -euo pipefail
          SPEC_FILE="${{ inputs.spec-path }}" # å°†è¾“å…¥èµ‹å€¼ç»™ä¸€ä¸ª shell å˜é‡ï¼Œæ–¹ä¾¿ä¸‹é¢ä½¿ç”¨
          echo "=== Q-API 3.3 Compliance Checks on $SPEC_FILE ==="

          echo "[check] OpenAPI version"
          OPENAPI_VER=$(yq '.openapi' "$SPEC_FILE")
          echo "OpenAPI version: $OPENAPI_VER"
          [[ "$OPENAPI_VER" =~ ^3\.1\. ]] || (echo "[FAIL] OpenAPI version must be 3.1.x"; exit 1)

          # ... æ­¤å¤„çœç•¥äº†åŽé¢æ‰€æœ‰æ£€æŸ¥çš„è„šæœ¬ ...
          # ... å®ƒä»¬éƒ½ä¼šè‡ªåŠ¨ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„ $SPEC_FILE å˜é‡ ...
          # ... æ— éœ€å¯¹ä¸‹é¢çš„æ¯ä¸€è¡Œéƒ½åšä¿®æ”¹ ...
          
          echo "[check] Q-API Profile"
          PROFILE=$(yq '.info."x-qapi-profile"' "$SPEC_FILE")
          echo "x-qapi-profile: $PROFILE"
          [[ "$PROFILE" == "3.3" ]] || (echo "[FAIL] Expected x-qapi-profile=3.3"; exit 1)

          echo "[check] Domain"
          DOMAIN=$(yq '.info."x-qapi-domain"' "$SPEC_FILE")
          echo "x-qapi-domain: $DOMAIN"
          [[ "$DOMAIN" == "os" ]] || (echo "[FAIL] Expected x-qapi-domain=os"; exit 1)

          echo "[check] OAuth2 scopes"
          for s in os.capabilities.read os.idempotency.check os.audit.write os.budget.write os.meter.write os.policy.read os.timebase.read; do
            echo "  - verifying $s"
            yq ".components.securitySchemes.oauth2.flows.clientCredentials.scopes.\"$s\"" "$SPEC_FILE" >/dev/null \
              || (echo "[FAIL] Missing scope: $s" && exit 1)
          done

          echo "[check] Required headers"
          for H in X-QAPI-Version X-Tenant-Id X-Trace-Id X-Request-Id; do
            MISS=$(yq --arg H "$H" '.paths.*.* | select(has("operationId")) | select(((.parameters // []) | map(.name==$H) | any) | not) | .operationId' -r "$SPEC_FILE" || true)
            if [ -n "$MISS" ]; then
              echo "[FAIL] Missing header $H in operations:"
              echo "$MISS"
              exit 1
            fi
          done

          echo "[check] Idempotency-Key on POSTs"
          POST_OPS=$(yq '.paths.*.post.operationId' -r "$SPEC_FILE" || true)
          for OP in $POST_OPS; do
            HAS=$(yq --arg OP "$OP" '.paths.*.post | select(.operationId==$OP) | (.parameters // []) | map(.name=="Idempotency-Key") | any' -r "$SPEC_FILE")
            [ "$HAS" = "true" ] || (echo "[FAIL] Missing Idempotency-Key in POST: $OP" && exit 1)
          done

          echo "âœ… All Q-API 3.3 compliance checks passed."
          exit 0
          
      - name: Done
        shell: bash
        run: echo "Quality gate checks completed âœ…"
