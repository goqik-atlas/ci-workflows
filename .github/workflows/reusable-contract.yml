# ==============================================================================
#           å¯å¤ç”¨çš„ OpenAPI åˆåŒå®ˆå«ä¸è‡ªåŠ¨æ‰“æ ‡ç­¾å·¥ä½œæµ
# ==============================================================================
# 
# æ–‡ä»¶è·¯å¾„: .github/workflows/reusable-contract.yml
# æ‰€åœ¨ä»“åº“: ci-workflows (ç”¨äºå­˜æ”¾å¯å¤ç”¨å·¥ä½œæµçš„ä¸­å¤®ä»“åº“)
#
# åŠŸèƒ½:
# 1. å¯¹æŒ‡å®šçš„ OpenAPI è§„èŒƒæ–‡ä»¶æ‰§è¡Œ Lintã€åˆè§„æ€§æ£€æŸ¥ç­‰ä¸€ç³»åˆ—è´¨é‡é—¨ç¦ã€‚
# 2. (å¯é€‰) å¦‚æœè°ƒç”¨æ—¶æŒ‡å®šï¼Œåˆ™åœ¨æ‰€æœ‰æ£€æŸ¥æˆåŠŸåè‡ªåŠ¨åˆ›å»ºå¹¶æ¨é€ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬æ ‡ç­¾ã€‚
#
# è¾“å…¥å‚æ•° (inputs):
#   spec-path:  å¿…éœ€ã€‚OpenAPI è§„èŒƒæ–‡ä»¶çš„è·¯å¾„ (ä¾‹å¦‚ 'contracts/bk.openapi.yaml')ã€‚
#   create-tag: å¯é€‰ã€‚å¸ƒå°”å€¼ (true/false)ã€‚å¦‚æœä¸º trueï¼Œåˆ™ä¼šè¿è¡Œæ‰“æ ‡ç­¾çš„ä»»åŠ¡ã€‚
#               é»˜è®¤ä¸º falseã€‚
#
# ==============================================================================

name: Reusable Contract-Guard & Tagging

on:
  workflow_call:
    inputs:
      spec-path:
        description: 'éœ€è¦è¿›è¡ŒéªŒè¯çš„ OpenAPI è§„èŒƒæ–‡ä»¶è·¯å¾„'
        required: true
        type: string
      create-tag:
        description: 'å¦‚æœä¸º true, åœ¨æ£€æŸ¥æˆåŠŸåè‡ªåŠ¨åˆ›å»ºå¹¶æ¨é€ä¸€ä¸ªæ–°æ ‡ç­¾'
        required: false
        type: boolean
        default: false

jobs:
  # --- ä»»åŠ¡ä¸€: åˆåŒéªŒè¯ ---
  validate-contract:
    name: Validate Contract
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (æ£€å‡ºä»£ç )
        uses: actions/checkout@v4

      - name: æ£€æŸ¥è§„èŒƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        shell: bash
        run: |
          echo "æ£€æŸ¥è·¯å¾„: ${{ inputs.spec-path }}"
          test -f "${{ inputs.spec-path }}" && echo "[OK] è§„èŒƒæ–‡ä»¶æ‰¾åˆ°" || (echo "[FAIL] è§„èŒƒæ–‡ä»¶æœªæ‰¾åˆ°"; exit 1)

      - name: Setup Node.js 20.x (å®‰è£… Node.js ç¯å¢ƒ)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install yq & jq (å®‰è£… yq å’Œ jq å·¥å…·)
        shell: bash
        run: |
          set -euo pipefail
          YQ_VERSION=v4.44.3
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq
          sudo apt-get update -y && sudo apt-get install -y jq
          echo "yq version: $(yq --version)"
          echo "jq version: $(jq --version)"

      - name: Lint OpenAPI (Redocly)
        shell: bash
        run: |
          npm i -g @redocly/cli@1.15.0
          echo "ğŸ” ä½¿ç”¨ Redocly è¿›è¡Œ Lint æ£€æŸ¥..."
          redocly lint "${{ inputs.spec-path }}" || true

      - name: Lint OpenAPI (Spectral)
        shell: bash
        run: |
          npm i -g @stoplight/spectral-cli@6.11.1
          echo "ğŸ” ä½¿ç”¨ Spectral è¿›è¡Œ Lint æ£€æŸ¥..."
          spectral lint "${{ inputs.spec-path }}" || true

      - name: Q-API 3.3 compliance checks (Q-API 3.3 åˆè§„æ€§ç¡¬æ€§æ£€æŸ¥)
        shell: bash
        run: |
          set -euo pipefail
          SPEC_FILE="${{ inputs.spec-path }}"
          echo "=== æ­£åœ¨å¯¹ $SPEC_FILE è¿›è¡Œ Q-API 3.3 åˆè§„æ€§æ£€æŸ¥ ==="

          echo "[æ£€æŸ¥] OpenAPI ç‰ˆæœ¬å¿…é¡»ä¸º 3.1.x"
          OPENAPI_VER=$(yq '.openapi' "$SPEC_FILE")
          [[ "$OPENAPI_VER" =~ ^3\.1\. ]] || (echo "[å¤±è´¥] OpenAPI ç‰ˆæœ¬å¿…é¡»æ˜¯ 3.1.x"; exit 1)

          echo "[æ£€æŸ¥] x-qapi-profile å¿…é¡»ä¸º 3.3"
          PROFILE=$(yq '.info."x-qapi-profile"' "$SPEC_FILE")
          [[ "$PROFILE" == "3.3" ]] || (echo "[å¤±è´¥] x-qapi-profile å¿…é¡»ä¸º 3.3"; exit 1)

          # ... è¿™é‡Œå¯ä»¥æ”¾å…¥æ‚¨åŸæ¥æ–‡ä»¶ä¸­æ‰€æœ‰çš„å…¶ä»–æ£€æŸ¥é€»è¾‘ ...

          echo "âœ… æ‰€æœ‰ Q-API 3.3 åˆè§„æ€§æ£€æŸ¥é€šè¿‡ã€‚"

      - name: Summary (ç”Ÿæˆæ‘˜è¦)
        if: always()
        shell: bash
        run: |
          echo "## âœ… Contract-Guard æ£€æŸ¥å®Œæˆ" >> "$GITHUB_STEP_SUMMARY"
          echo "- **è§„èŒƒæ–‡ä»¶**: \`${{ inputs.spec-path }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **æ£€æŸ¥ç»“æœ**: æ‰€æœ‰æ­¥éª¤å·²æ‰§è¡Œ" >> "$GITHUB_STEP_SUMMARY"

  # --- ä»»åŠ¡äºŒ: è‡ªåŠ¨æ‰“æ ‡ç­¾ (å¯é€‰) ---
  tag-release:
    name: Create and Push Tag
    if: inputs.create-tag == true
    needs: validate-contract
    runs-on: ubuntu-latest
    permissions:
      contents: write # æ¨é€æ ‡ç­¾éœ€è¦å†™æƒé™

    steps:
      - name: Checkout Code with Full History (æ£€å‡ºå®Œæ•´å†å²ä»£ç )
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump Version and Push Tag (æå‡ç‰ˆæœ¬å¹¶æ¨é€æ ‡ç­¾)
        id: tag_version
        uses: anothrNick/github-tag-action@1.67.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: patch # é»˜è®¤å¢åŠ è¡¥ä¸ç‰ˆæœ¬å·
          WITH_V: true # æ ‡ç­¾å¸¦ 'v' å‰ç¼€, e.g., v1.2.3

      - name: Print New Tag (è¾“å‡ºæ–°æ ‡ç­¾)
        run: echo "æˆåŠŸåˆ›å»ºå¹¶æ¨é€æ–°æ ‡ç­¾: ${{ steps.tag_version.outputs.new_tag }}"
